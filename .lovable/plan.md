
# תוכנית לתיקון קפיצת כלי B וחלקות פאן (משימה 5)

## בעיות שזוהו

### בעיה 1: כלי B קופץ ממשימה 1 למשימה 2
**הסיבה השורשית:** כשכלי B מונח במשימה 1, הקואורדינטות שלו נשמרות ב-`fixedPlacement` לפי הרקע הנוכחי (`galleryMainStylized`). כאשר המשחק עובר למשימה 2, הרקע מתחלף לקירות הלבנים (`studio_in_gallery_wall_bg`), אבל הקואורדינטות נשארות מחושבות לפי הרקע הישן - מה שגורם לכלי "לקפוץ" למיקום שנראה שונה.

**מה קורה בקוד:**
- ב-`calculateFixedPlacement` (שורה 350-376), הקואורדינטות מחושבות לפי `lockedBgKey`
- במשימה 1, `lockedBgKey` הוא הרקע הראשוני (לא הקירות הלבנים)
- כאשר עוברים למשימה 2, הרקע משתנה אבל הקואורדינטות כבר "קפואות"

### בעיה 2: פאן קופץ במשימה 5
**הסיבה השורשית:** מערכת הפנורמה (`usePanningBackground`) לא מתאפסת בצורה חלקה כשעוברים לרקע חיצוני (פארק). המעבר בין רקעים עם יחסי גובה/רוחב שונים גורם לקפיצה.

---

## פתרון מוצע

### תיקון 1: שמירת קואורדינטות לפי הרקע הבא (לא הנוכחי)
**לוגיקה:** כלי עם `persist: 'keep'` צריך לשמור את הקואורדינטות שלו לפי הרקע *שבו הוא יוצג* (הרקע הבא), לא לפי הרקע שבו הוא הונח.

**שינויים:**
1. ב-`calculateFixedPlacement`, לבדוק אם יש `next_bg_override` ולחשב לפיו
2. או: לחשב קואורדינטות נורמליזציות (0-1) שיתרגמו דינמית לכל רקע

### תיקון 2: איפוס חלק של הפאן במעברי רקע
**לוגיקה:** כשהרקע משתנה (במיוחד בין פנים לחוץ), לאפס את ה-pan לערך ברירת מחדל בהדרגה (animation) במקום קפיצה חדה.

**שינויים:**
1. ב-`usePanningBackground`, להוסיף transition ל-`backgroundPosition` כשמשתנה ה-`bgKey`
2. או: CSS transition על ה-`backgroundPosition` בזמן החלפת רקע

---

## פרטים טכניים

### שינוי 1: `src/components/VisualPlayScreen.tsx`
```text
calculateFixedPlacement (שורות 348-376):
- שינוי: בדיקה אם זו משימה 1 ויש next_bg_override
- אם כן: לחשב את הקואורדינטות לפי הרקע הבא (galleryMainStylizedWhite)
- כך הכלי יונח במקום שמתאים לרקע שבו הוא יוצג
```

### שינוי 2: `src/hooks/usePanningBackground.ts`
```text
- הוספת effect שמזהה שינוי ב-bgKey
- כשמשתנה, להחיל transition חלק (0.5s ease) לאיפוס הפאן
- או: CSS transition על background-position
```

### שינוי 3: `src/components/BackgroundCrossfade.tsx` (אם קיים)
```text
- לוודא שה-crossfade בין רקעים מסתיר את קפיצת הפאן
```

---

## סדר עדיפויות
1. **תיקון קפיצת כלי B** - הכי דחוף כי משפיע על חוויית המשחק הבסיסית
2. **תיקון פאן משימה 5** - משני אבל חשוב לחוויה חלקה
3. **שכבות דמויות** - את תנסי שוב עם התיקון הקודם

---

## הערה על חיסכון בקרדיטים
אם תאשרי את התוכנית, אעשה את שני התיקונים ביחד בהודעה אחת - כך נחסוך קרדיטים במקום לעשות אותם בנפרד.

גם כדאי לדעת: **Plan Mode הזה לא צורך קרדיטים** - רק ההודעות שמשנות קוד צורכות. אז אם משהו לא ברור, עדיף לשאול כאן לפני שמאשרים.
